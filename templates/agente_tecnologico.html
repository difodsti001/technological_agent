<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agente TecnolÃ³gico Â· SIFODS</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* â”€â”€â”€ VARIABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        :root {
            --bg:          #0f1117;
            --surface:     #1a1d27;
            --surface2:    #22263a;
            --border:      #2e3248;
            --border-soft: #252840;

            --primary:     #6c8eff;
            --primary-dim: #3d5bd9;
            --accent:      #ff6b9d;
            --accent2:     #43e8d8;
            --warn:        #ffc654;

            --txt:         #e8eaf6;
            --txt-soft:    #8b90b0;
            --txt-dim:     #555a7a;

            --radius-sm:   8px;
            --radius-md:   14px;
            --radius-lg:   22px;
            --radius-xl:   30px;

            --shadow:      0 8px 32px rgba(0,0,0,.45);
            --shadow-sm:   0 2px 12px rgba(0,0,0,.3);
            --success:     #43e8a8;
            --error:       #ff5e7e;
        }

        * { margin:0; padding:0; box-sizing:border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--txt);
            min-height: 100vh;
            padding: 28px 20px;
            /* Subtle grid texture */
            background-image:
                linear-gradient(rgba(108,142,255,.04) 1px, transparent 1px),
                linear-gradient(90deg, rgba(108,142,255,.04) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .container {
            max-width: 1160px;
            margin: 0 auto;
        }

        /* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header {
            display: flex;
            align-items: center;
            gap: 18px;
            padding: 24px 32px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 28px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -60px; right: -60px;
            width: 200px; height: 200px;
            background: radial-gradient(circle, rgba(108,142,255,.15) 0%, transparent 70%);
        }

        .header-badge {
            width: 58px; height: 58px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: var(--radius-md);
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
            box-shadow: 0 0 24px rgba(108,142,255,.4);
        }

        .header-text h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--txt);
            letter-spacing: -.3px;
        }

        .header-text p {
            font-size: 13px;
            color: var(--txt-soft);
            margin-top: 3px;
        }

        .header-pill {
            margin-left: auto;
            background: rgba(108,142,255,.12);
            border: 1px solid rgba(108,142,255,.3);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'DM Mono', monospace;
            letter-spacing: .5px;
            flex-shrink: 0;
        }

        /* â”€â”€â”€ MÃ“DULOS GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modules-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }

        .module-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 22px 20px;
            cursor: pointer;
            transition: all .25s ease;
            position: relative;
            overflow: hidden;
        }

        .module-card::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: var(--radius-md);
            opacity: 0;
            transition: opacity .25s;
        }

        .module-card:hover:not(.disabled) {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .module-card:hover:not(.disabled)::after { opacity: 1; }

        .module-card.active {
            border-color: var(--primary);
            background: linear-gradient(160deg, #1a2040, #1e2550);
            box-shadow: 0 0 0 1px var(--primary), var(--shadow);
        }

        .module-card.disabled {
            opacity: .4;
            cursor: not-allowed;
        }

        /* Accent top bar */
        .module-card .bar {
            height: 3px;
            border-radius: 2px;
            margin-bottom: 16px;
        }

        .module-card.sifods .bar        { background: linear-gradient(90deg, var(--primary), #9b8fff); }
        .module-card.recomendacion .bar { background: linear-gradient(90deg, var(--accent), var(--warn)); }
        .module-card.tarea3 .bar        { background: linear-gradient(90deg, var(--accent2), #4facfe); }
        .module-card.tarea4 .bar        { background: linear-gradient(90deg, #43e97b, #38f9d7); }

        .module-icon {
            font-size: 30px;
            margin-bottom: 10px;
            display: block;
        }

        .module-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--txt);
            margin-bottom: 6px;
        }

        .module-desc {
            font-size: 12px;
            color: var(--txt-soft);
            line-height: 1.5;
        }

        .module-status {
            display: inline-block;
            margin-top: 12px;
            padding: 3px 10px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: .8px;
            font-family: 'DM Mono', monospace;
        }

        .status-active    { background: rgba(108,142,255,.15); color: var(--primary); border: 1px solid rgba(108,142,255,.3); }
        .status-available { background: rgba(67,232,216,.1);  color: var(--accent2); border: 1px solid rgba(67,232,216,.25); }
        .status-soon      { background: rgba(139,144,176,.1); color: var(--txt-dim); border: 1px solid var(--border); }

        /* â”€â”€â”€ PANEL ÃREA (donde se inyecta el mÃ³dulo activo) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel-area {
            display: none;
        }

        .panel-area.visible {
            display: block;
            animation: slideUp .3s ease;
        }

        @keyframes slideUp {
            from { opacity:0; transform:translateY(16px); }
            to   { opacity:1; transform:translateY(0); }
        }

        /* â”€â”€â”€ PANEL HEADER (comÃºn a ambos mÃ³dulos) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            border-bottom: none;
        }

        .panel-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-header-icon {
            width: 38px; height: 38px;
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }

        .icon-sifods        { background: linear-gradient(135deg, var(--primary), #9b8fff); }
        .icon-recomendacion { background: linear-gradient(135deg, var(--accent), var(--warn)); }

        .panel-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--txt);
        }

        .panel-header p {
            font-size: 12px;
            color: var(--txt-soft);
            margin-top: 1px;
        }

        .btn-close {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--txt-soft);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
            transition: all .2s;
        }

        .btn-close:hover { background: var(--border); color: var(--txt); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MÃ“DULO 1 â€” CHAT SIFODS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #panel-sifods {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        /* Quick suggestions */
        .suggestions-bar {
            padding: 12px 24px 14px;
            background: var(--surface2);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .suggestions-label {
            font-size: 11px;
            color: var(--txt-dim);
            font-weight: 600;
            letter-spacing: .5px;
            text-transform: uppercase;
            flex-shrink: 0;
        }

        .suggestion-chip {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--txt-soft);
            padding: 6px 14px;
            border-radius: 99px;
            font-size: 12px;
            cursor: pointer;
            transition: all .2s;
            font-family: 'DM Sans', sans-serif;
        }

        .suggestion-chip:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Chatbox */
        .chatbox {
            height: 420px;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg);
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .chatbox::-webkit-scrollbar { width: 4px; }
        .chatbox::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* Messages */
        .message { margin-bottom: 16px; animation: fadeMsg .3s ease; }

        @keyframes fadeMsg {
            from { opacity:0; transform:translateY(8px); }
            to   { opacity:1; transform:translateY(0); }
        }

        .msg-user { display: flex; flex-direction: column; align-items: flex-end; }
        .msg-bot  { display: flex; flex-direction: column; align-items: flex-start; }

        .msg-bubble {
            max-width: 68%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .msg-user .msg-bubble {
            background: linear-gradient(135deg, var(--primary-dim), var(--primary));
            color: white;
            border-radius: 18px 18px 4px 18px;
        }

        .msg-bot .msg-bubble {
            background: var(--surface2);
            color: var(--txt);
            border: 1px solid var(--border);
            border-radius: 18px 18px 18px 4px;
        }

        .msg-time {
            font-size: 10px;
            color: var(--txt-dim);
            margin-top: 4px;
            font-family: 'DM Mono', monospace;
        }

        /* Typing indicator */
        .typing-row {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 0 24px 12px;
            background: var(--bg);
        }

        .typing-row.active { display: flex; }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 18px 18px 18px 4px;
        }

        .typing-dots span {
            width: 7px; height: 7px;
            background: var(--txt-dim);
            border-radius: 50%;
            animation: bounce 1.3s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: .2s; }
        .typing-dots span:nth-child(3) { animation-delay: .4s; }

        @keyframes bounce {
            0%,60%,100% { transform: translateY(0); }
            30%          { transform: translateY(-8px); }
        }

        /* Input area */
        .chat-input-area {
            padding: 16px 24px;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--txt);
            padding: 12px 18px;
            border-radius: 99px;
            font-size: 14px;
            font-family: 'DM Sans', sans-serif;
            outline: none;
            transition: border-color .2s;
        }

        .chat-input::placeholder { color: var(--txt-dim); }
        .chat-input:focus { border-color: var(--primary); }

        .btn-send {
            background: linear-gradient(135deg, var(--primary-dim), var(--primary));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 99px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: 'DM Sans', sans-serif;
            transition: all .2s;
            white-space: nowrap;
        }

        .btn-send:hover  { transform: scale(1.04); box-shadow: 0 0 16px rgba(108,142,255,.4); }
        .btn-send:active { transform: scale(.98); }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MÃ“DULO 2 â€” RECOMENDACIÃ“N DE CURSOS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        #panel-recomendacion {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        /* Loading state */
        .rec-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 64px 24px;
            gap: 16px;
            background: var(--bg);
        }

        .rec-loading.hidden { display: none; }

        .loading-spinner {
            width: 44px; height: 44px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin .8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 14px;
            color: var(--txt-soft);
        }

        /* Cards grid */
        .rec-body {
            background: var(--bg);
            padding: 24px;
        }

        .rec-body.hidden { display: none; }

        .rec-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .rec-meta-title {
            font-size: 13px;
            color: var(--txt-soft);
            font-weight: 500;
        }

        .rec-meta-title strong {
            color: var(--txt);
        }

        .btn-refresh {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--txt-soft);
            padding: 7px 14px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 12px;
            font-family: 'DM Sans', sans-serif;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all .2s;
        }

        .btn-refresh:hover { border-color: var(--primary); color: var(--primary); }

        .courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }

        /* Tarjeta de curso */
        .course-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            transition: all .25s ease;
            position: relative;
        }

        .course-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent);
            box-shadow: 0 12px 32px rgba(0,0,0,.4), 0 0 0 1px rgba(255,107,157,.2);
        }

        .course-card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255,107,157,.35);
        }

        .course-card-accent {
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--warn));
        }

        .course-card-body {
            padding: 16px;
        }

        .course-rank {
            font-size: 10px;
            font-weight: 700;
            font-family: 'DM Mono', monospace;
            color: var(--accent);
            letter-spacing: 1px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .course-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--txt);
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .course-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .course-tag {
            background: var(--surface2);
            border: 1px solid var(--border-soft);
            color: var(--txt-soft);
            padding: 3px 9px;
            border-radius: 99px;
            font-size: 11px;
        }

        .course-stats {
            display: flex;
            gap: 12px;
        }

        .stat {
            display: flex;
            flex-direction: column;
        }

        .stat-val {
            font-size: 15px;
            font-weight: 700;
            color: var(--txt);
            font-family: 'DM Mono', monospace;
        }

        .stat-lbl {
            font-size: 10px;
            color: var(--txt-dim);
            margin-top: 1px;
        }

        .course-card-footer {
            padding: 10px 16px;
            background: var(--surface2);
            border-top: 1px solid var(--border-soft);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .score-bar-wrap {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-right: 10px;
        }

        .score-bar {
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .score-val {
            font-size: 11px;
            font-family: 'DM Mono', monospace;
            color: var(--txt-soft);
            flex-shrink: 0;
        }

        .btn-justificacion {
            font-size: 11px;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            padding: 0;
            text-decoration: underline;
            text-underline-offset: 3px;
            margin-left: 10px;
            flex-shrink: 0;
        }

        /* â”€â”€â”€ PANEL DE JUSTIFICACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .justificacion-panel {
            display: none;
            background: var(--surface);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            padding: 24px;
            animation: slideUp .25s ease;
        }

        .justificacion-panel.visible {
            display: block;
        }

        .just-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            margin-bottom: 16px;
        }

        .just-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--warn));
            border-radius: var(--radius-sm);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .just-course-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--txt);
        }

        .just-label {
            font-size: 11px;
            color: var(--txt-dim);
            margin-top: 2px;
            font-family: 'DM Mono', monospace;
        }

        .just-text {
            background: var(--bg);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: var(--radius-sm);
            padding: 16px 20px;
            font-size: 14px;
            color: var(--txt);
            line-height: 1.7;
        }

        .just-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--txt-soft);
        }

        .just-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 14px;
        }

        .just-chip {
            background: var(--surface2);
            border: 1px solid var(--border-soft);
            color: var(--txt-soft);
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 11px;
        }

        .just-chip.highlight {
            background: rgba(108,142,255,.1);
            border-color: rgba(108,142,255,.3);
            color: var(--primary);
        }


        /* â”€â”€â”€ BADGE DNI en header del panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panel-header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dni-badge {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,107,157,.08);
            border: 1px solid rgba(255,107,157,.25);
            border-radius: 99px;
            padding: 6px 14px 6px 8px;
            cursor: pointer; transition: all .2s;
        }
        .dni-badge:hover {
            background: rgba(255,107,157,.16);
            border-color: rgba(255,107,157,.5);
        }
        .dni-avatar {
            width: 26px; height: 26px;
            background: linear-gradient(135deg, var(--accent), var(--warn));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; flex-shrink: 0;
        }
        .dni-info  { display: flex; flex-direction: column; line-height: 1.25; }
        .dni-label { font-size: 9px; color: var(--txt-dim); font-family: "DM Mono", monospace; letter-spacing: .5px; }
        .dni-value { font-size: 12px; font-weight: 600; color: var(--accent); font-family: "DM Mono", monospace; }
        .dni-edit  { font-size: 11px; color: var(--txt-dim); margin-left: 2px; }
        .loading-dni {
            font-size: 12px; color: var(--txt-dim);
            font-family: "DM Mono", monospace; margin-top: -8px;
        }

        /* â”€â”€â”€ MODAL DNI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(8,10,18,.82);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            z-index: 1000;
            align-items: center; justify-content: center; padding: 20px;
        }
        .modal-overlay.visible { display: flex; animation: fadeOverlay .2s ease; }
        @keyframes fadeOverlay { from { opacity:0; } to { opacity:1; } }
        .modal-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: 40px 40px 34px;
            max-width: 440px; width: 100%;
            box-shadow: 0 32px 80px rgba(0,0,0,.65), 0 0 0 1px rgba(255,107,157,.12);
            animation: modalPop .3s cubic-bezier(.34,1.56,.64,1);
            position: relative; overflow: hidden;
        }
        .modal-card::before {
            content: ""; position: absolute; top: -80px; right: -80px;
            width: 240px; height: 240px;
            background: radial-gradient(circle, rgba(255,107,157,.11) 0%, transparent 70%);
            pointer-events: none;
        }
        .modal-card::after {
            content: ""; position: absolute; bottom: -60px; left: -60px;
            width: 180px; height: 180px;
            background: radial-gradient(circle, rgba(108,142,255,.07) 0%, transparent 70%);
            pointer-events: none;
        }
        @keyframes modalPop {
            from { opacity:0; transform: scale(.9) translateY(20px); }
            to   { opacity:1; transform: scale(1) translateY(0); }
        }
        .modal-icon-wrap {
            width: 70px; height: 70px; margin: 0 auto 24px;
            background: linear-gradient(135deg, rgba(255,107,157,.18), rgba(255,198,84,.12));
            border: 1px solid rgba(255,107,157,.28);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 34px; position: relative; z-index: 1;
        }
        .modal-title {
            font-size: 20px; font-weight: 700; text-align: center;
            margin-bottom: 8px; position: relative; z-index: 1;
        }
        .modal-subtitle {
            font-size: 13px; color: var(--txt-soft); text-align: center;
            line-height: 1.65; margin-bottom: 26px; position: relative; z-index: 1;
        }
        .modal-info {
            background: rgba(108,142,255,.07);
            border: 1px solid rgba(108,142,255,.2);
            border-radius: var(--radius-sm);
            padding: 10px 14px; font-size: 12px; color: var(--txt-soft);
            line-height: 1.55; margin-bottom: 22px;
            display: flex; align-items: flex-start; gap: 8px;
            position: relative; z-index: 1;
        }
        .modal-info-icon { flex-shrink: 0; margin-top: 1px; }
        .dni-input-label {
            display: block; font-size: 11px; font-weight: 600;
            color: var(--txt-dim); letter-spacing: .8px;
            font-family: "DM Mono", monospace; text-transform: uppercase;
            margin-bottom: 8px; position: relative; z-index: 1;
        }
        .dni-input-wrap { position: relative; margin-bottom: 6px; z-index: 1; }
        .dni-input-field {
            width: 100%; background: var(--surface2);
            border: 2px solid var(--border); color: var(--txt);
            padding: 14px 50px 14px 18px;
            border-radius: var(--radius-md);
            font-size: 22px; font-family: "DM Mono", monospace;
            font-weight: 500; letter-spacing: 5px; text-align: center;
            outline: none; transition: all .22s;
        }
        .dni-input-field::placeholder { color: var(--txt-dim); letter-spacing: 3px; font-size: 18px; }
        .dni-input-field:focus {
            border-color: var(--accent);
            background: rgba(255,107,157,.04);
            box-shadow: 0 0 0 4px rgba(255,107,157,.11);
        }
        .dni-input-field.dni-error {
            border-color: var(--error); box-shadow: 0 0 0 4px rgba(255,94,126,.11);
        }
        .dni-input-field.dni-ok {
            border-color: var(--success); box-shadow: 0 0 0 4px rgba(67,232,168,.11);
        }
        .dni-char-count {
            position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
            font-size: 11px; color: var(--txt-dim);
            font-family: "DM Mono", monospace; pointer-events: none;
        }
        .dni-error-msg {
            font-size: 12px; color: var(--error);
            min-height: 18px; margin-bottom: 18px;
            display: flex; align-items: center; gap: 4px;
            position: relative; z-index: 1;
        }
        .btn-modal-primary {
            width: 100%;
            background: linear-gradient(135deg, #c0547c, var(--accent));
            color: white; border: none; padding: 15px;
            border-radius: var(--radius-md);
            font-size: 15px; font-weight: 700; font-family: "DM Sans", sans-serif;
            cursor: pointer; transition: all .22s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            position: relative; z-index: 1;
        }
        .btn-modal-primary:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 8px 28px rgba(255,107,157,.38);
        }
        .btn-modal-primary:active:not(:disabled) { transform: translateY(0); }
        .btn-modal-primary:disabled { opacity: .42; cursor: not-allowed; }
        .modal-footer-note {
            font-size: 11px; color: var(--txt-dim);
            text-align: center; margin-top: 14px; line-height: 1.55;
            position: relative; z-index: 1;
        }
        .modal-footer-note a {
            color: var(--txt-soft); text-decoration: underline;
            text-underline-offset: 3px; cursor: pointer;
        }

        /* â”€â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 900px) {
            .modules-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 560px) {
            .modules-grid { grid-template-columns: 1fr; }
            .header-pill  { display: none; }
            .msg-bubble   { max-width: 88%; }
            .courses-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="header">
        <div class="header-badge">ğŸ”§</div>
        <div class="header-text">
            <h1>Agente TecnolÃ³gico Â· SIFODS</h1>
            <p>Asistente de navegaciÃ³n y recomendaciones personalizadas Â· DIFODS</p>
        </div>
        <div class="header-pill">v2.0</div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MÃ“DULOS â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="modules-grid">

        <!-- MÃ³dulo 1: Chat SIFODS -->
        <div class="module-card sifods" id="card-sifods" onclick="abrirModulo('sifods')">
            <div class="bar"></div>
            <span class="module-icon">ğŸ—ºï¸</span>
            <div class="module-title">Ayuda con SIFODS</div>
            <div class="module-desc">Navega la plataforma, accede a recursos y resuelve problemas tÃ©cnicos.</div>
            <span class="module-status status-available" id="badge-sifods">DISPONIBLE</span>
        </div>

        <!-- MÃ³dulo 2: RecomendaciÃ³n -->
        <div class="module-card recomendacion" id="card-recomendacion" onclick="abrirModulo('recomendacion')">
            <div class="bar"></div>
            <span class="module-icon">ğŸ¯</span>
            <div class="module-title">RecomendaciÃ³n de Cursos</div>
            <div class="module-desc">Cursos personalizados segÃºn tu historial y perfil docente.</div>
            <span class="module-status status-available" id="badge-recomendacion">DISPONIBLE</span>
        </div>

        <!-- MÃ³dulo 3: PrÃ³ximamente -->
        <div class="module-card tarea3 disabled">
            <div class="bar"></div>
            <span class="module-icon">ğŸ“Š</span>
            <div class="module-title">Mi Progreso</div>
            <div class="module-desc">Consulta tu avance, cursos completados y estadÃ­sticas.</div>
            <span class="module-status status-soon">PRÃ“XIMAMENTE</span>
        </div>

        <!-- MÃ³dulo 4: PrÃ³ximamente -->
        <div class="module-card tarea4 disabled">
            <div class="bar"></div>
            <span class="module-icon">ğŸ“„</span>
            <div class="module-title">Constancias y Reportes</div>
            <div class="module-desc">Genera reportes de actividad y descarga tus constancias.</div>
            <span class="module-status status-soon">PRÃ“XIMAMENTE</span>
        </div>

    </div><!-- /modules-grid -->

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• PANEL ÃREA â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="panel-area" id="panel-area">

        <!-- â”€â”€â”€â”€â”€â”€â”€â”€ PANEL 1: CHAT SIFODS â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="panel-sifods" style="display:none;">
            <!-- Header -->
            <div class="panel-header">
                <div class="panel-header-left">
                    <div class="panel-header-icon icon-sifods">ğŸ—ºï¸</div>
                    <div>
                        <h2>Ayuda con SIFODS</h2>
                        <p>Asistente de navegaciÃ³n Â· RAG sobre manuales de la plataforma</p>
                    </div>
                </div>
                <button class="btn-close" onclick="cerrarModulo()">Cerrar âœ•</button>
            </div>

            <!-- Sugerencias -->
            <div class="suggestions-bar">
                <span class="suggestions-label">ğŸ’¡ Sugerencias</span>
                <button class="suggestion-chip" onclick="usarSugerencia('Â¿CÃ³mo accedo al Centro de Recursos?')">Centro de Recursos</button>
                <button class="suggestion-chip" onclick="usarSugerencia('No puedo iniciar sesiÃ³n, Â¿quÃ© hago?')">Problemas de acceso</button>
                <button class="suggestion-chip" onclick="usarSugerencia('Â¿DÃ³nde estÃ¡n los videos de YouTube?')">Videos YouTube</button>
                <button class="suggestion-chip" onclick="usarSugerencia('Â¿QuÃ© es la Zona FID?')">Zona FID</button>
                <button class="suggestion-chip" onclick="usarSugerencia('Â¿CÃ³mo descargo un recurso del Centro de Recursos?')">Descargar recursos</button>
            </div>

            <!-- Mensajes -->
            <div class="chatbox" id="chatbox">
                <!-- se llena dinÃ¡micamente -->
            </div>

            <!-- Typing -->
            <div class="typing-row" id="typing-row">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>

            <!-- Input -->
            <div class="chat-input-area">
                <input
                    class="chat-input"
                    id="chat-input"
                    type="text"
                    placeholder="Escribe tu pregunta sobre SIFODS..."
                    onkeydown="if(event.key==='Enter') enviarMensaje()"
                >
                <button class="btn-send" id="btn-send" onclick="enviarMensaje()">Enviar â†’</button>
            </div>
        </div><!-- /panel-sifods -->


        <!-- â”€â”€â”€â”€â”€â”€â”€â”€ PANEL 2: RECOMENDACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div id="panel-recomendacion" style="display:none;">

            <!-- Header -->
            <div class="panel-header">
                <div class="panel-header-left">
                    <div class="panel-header-icon icon-recomendacion">ğŸ¯</div>
                    <div>
                        <h2>RecomendaciÃ³n de Cursos</h2>
                        <p>Filtro colaborativo hÃ­brido Â· Resultados personalizados para ti</p>
                    </div>
                </div>
                <div class="panel-header-right">
                    <!-- Badge DNI visible cuando hay sesiÃ³n activa -->
                    <div class="dni-badge" id="dni-badge" onclick="abrirModalDni()"
                         title="Cambiar identificaciÃ³n" style="display:none;">
                        <div class="dni-avatar">ğŸ‘¤</div>
                        <div class="dni-info">
                            <span class="dni-label">DNI activo</span>
                            <span class="dni-value" id="dni-badge-value">â€”</span>
                        </div>
                        <span class="dni-edit">âœ</span>
                    </div>
                    <button class="btn-close" onclick="cerrarModulo()">Cerrar âœ•</button>
                </div>
            </div>

            <!-- Loading -->
            <div class="rec-loading" id="rec-loading">
                <div class="loading-spinner"></div>
                <div class="loading-text">Calculando recomendaciones personalizadasâ€¦</div>
                <div class="loading-dni" id="loading-dni-text"></div>
            </div>

            <!-- Body con cards -->
            <div class="rec-body hidden" id="rec-body">
                <div class="rec-meta">
                    <div class="rec-meta-title">
                        Mostrando <strong id="rec-count">0</strong> cursos recomendados para ti
                    </div>
                    <button class="btn-refresh" onclick="cargarRecomendaciones()">
                        â†» Actualizar
                    </button>
                </div>
                <div class="courses-grid" id="courses-grid">
                    <!-- Se llena dinÃ¡micamente -->
                </div>
            </div>

            <!-- Panel de justificaciÃ³n (aparece al hacer clic en una card) -->
            <div class="justificacion-panel" id="just-panel">
                <div class="just-header">
                    <div class="just-icon">âœ¨</div>
                    <div>
                        <div class="just-course-name" id="just-course-name">â€”</div>
                        <div class="just-label">JUSTIFICACIÃ“N DE LA IA</div>
                    </div>
                </div>
                <div class="just-text" id="just-text">
                    <div class="just-loading" id="just-loading">
                        <div class="loading-spinner" style="width:20px;height:20px;border-width:2px;"></div>
                        Generando justificaciÃ³nâ€¦
                    </div>
                    <span id="just-content" style="display:none;"></span>
                </div>
                <div class="just-chips" id="just-chips"></div>
            </div>

        </div><!-- /panel-recomendacion -->

    </div><!-- /panel-area -->

</div><!-- /container -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// v1: DNI ingresado por el docente en el modal (sin sesiÃ³n integrada).
// v2 futura: leer USUARIO_DNI desde token de sesiÃ³n SIFODS.
let USUARIO_DNI         = null;
const API_BASE          = "";   // mismo origen
let moduloActivo        = null;
let recomendacionesData = [];
let cursoSeleccionado   = null;


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL DE IDENTIFICACIÃ“N DNI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/** Abre el modal. Si ya hay DNI, prerellena el campo. */
function abrirModalDni() {
    const overlay = document.getElementById('modal-dni');
    const input   = document.getElementById('input-dni');
    const errMsg  = document.getElementById('dni-error');
    const linkCan = document.getElementById('link-cancelar');

    if (USUARIO_DNI) {
        input.value = USUARIO_DNI;
        actualizarContador(USUARIO_DNI.length);
        document.getElementById('btn-confirmar-dni').disabled = false;
        input.classList.add('dni-ok');
        linkCan.style.display = 'inline';
    } else {
        input.value = '';
        actualizarContador(0);
        document.getElementById('btn-confirmar-dni').disabled = true;
        input.classList.remove('dni-ok', 'dni-error');
        linkCan.style.display = 'none';
    }

    errMsg.textContent = '';
    overlay.classList.add('visible');
    setTimeout(() => input.focus(), 140);
}

/** Cierra el modal sin cambiar el DNI (solo si ya habÃ­a uno) */
function cancelarModal() {
    if (USUARIO_DNI) {
        document.getElementById('modal-dni').classList.remove('visible');
    }
}

/** ValidaciÃ³n en tiempo real: solo dÃ­gitos, habilitar botÃ³n al llegar a 8 */
function onDniInput(input) {
    input.value = input.value.replace(/\D/g, '');   // solo nÃºmeros
    const len     = input.value.length;
    const btnConf = document.getElementById('btn-confirmar-dni');
    const errMsg  = document.getElementById('dni-error');

    actualizarContador(len);
    errMsg.textContent = '';
    input.classList.remove('dni-ok', 'dni-error');

    if (len === 8) {
        input.classList.add('dni-ok');
        btnConf.disabled = false;
    } else {
        btnConf.disabled = true;
    }
}

function actualizarContador(len) {
    document.getElementById('dni-char-count').textContent = `${len}/8`;
}

/** Confirma el DNI, lo guarda y dispara la carga de recomendaciones */
function confirmarDni() {
    const input  = document.getElementById('input-dni');
    const errMsg = document.getElementById('dni-error');
    const dni    = input.value.trim();

    if (!/^\d{8}$/.test(dni)) {
        input.classList.add('dni-error');
        errMsg.textContent = 'âš ï¸ El DNI debe tener exactamente 8 dÃ­gitos.';
        input.focus();
        return;
    }

    USUARIO_DNI = dni;
    document.getElementById('modal-dni').classList.remove('visible');
    mostrarBadgeDni(dni);
    cargarRecomendaciones();
}

/** Muestra el badge con el DNI en el header del panel */
function mostrarBadgeDni(dni) {
    const badge = document.getElementById('dni-badge');
    document.getElementById('dni-badge-value').textContent = dni;
    badge.style.display = 'flex';
}

// Cerrar con clic fuera de la tarjeta (solo si ya hay DNI)
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('modal-dni').addEventListener('click', function(e) {
        if (e.target === this && USUARIO_DNI) cancelarModal();
    });
});

// Cerrar con Escape (solo si ya hay DNI)
document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && USUARIO_DNI) cancelarModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVEGACIÃ“N DE MÃ“DULOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function abrirModulo(modulo) {
    // Ocultar todo
    document.getElementById('panel-sifods').style.display        = 'none';
    document.getElementById('panel-recomendacion').style.display  = 'none';

    // Desactivar badges
    ['sifods','recomendacion'].forEach(m => {
        const card  = document.getElementById(`card-${m}`);
        const badge = document.getElementById(`badge-${m}`);
        card.classList.remove('active');
        badge.textContent  = 'DISPONIBLE';
        badge.className    = 'module-status status-available';
    });

    // Activar mÃ³dulo seleccionado
    moduloActivo = modulo;
    const card  = document.getElementById(`card-${modulo}`);
    const badge = document.getElementById(`badge-${modulo}`);
    card.classList.add('active');
    badge.textContent = 'ACTIVO';
    badge.className   = 'module-status status-active';

    // Mostrar panel
    const panelArea = document.getElementById('panel-area');
    panelArea.classList.add('visible');
    document.getElementById(`panel-${modulo}`).style.display = 'block';

    // Scroll al panel
    panelArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // LÃ³gica especÃ­fica por mÃ³dulo
    if (modulo === 'sifods') {
        iniciarChatSifods();
    } else if (modulo === 'recomendacion') {
        // Si aÃºn no hay DNI â†’ pedir antes de cargar recomendaciones
        if (!USUARIO_DNI) {
            abrirModalDni();
        } else {
            cargarRecomendaciones();
        }
    }
}

function cerrarModulo() {
    document.getElementById('panel-sifods').style.display        = 'none';
    document.getElementById('panel-recomendacion').style.display  = 'none';
    document.getElementById('panel-area').classList.remove('visible');

    ['sifods','recomendacion'].forEach(m => {
        document.getElementById(`card-${m}`).classList.remove('active');
        const badge = document.getElementById(`badge-${m}`);
        badge.textContent = 'DISPONIBLE';
        badge.className   = 'module-status status-available';
    });

    moduloActivo      = null;
    cursoSeleccionado = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 1 â€” CHAT SIFODS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function iniciarChatSifods() {
    const chatbox = document.getElementById('chatbox');
    chatbox.innerHTML = '';
    agregarMensajeBot(
        'ğŸ‘‹ Â¡Hola! Soy tu asistente para navegar <strong>SIFODS</strong>.\n' +
        'Puedo ayudarte con el Centro de Recursos, acceso a la plataforma, ' +
        'videos de YouTube, la Zona FID y mucho mÃ¡s.\n\nÂ¿En quÃ© te puedo ayudar hoy?'
    );
}

function agregarMensajeUsuario(texto) {
    const chatbox = document.getElementById('chatbox');
    const div = document.createElement('div');
    div.className = 'message msg-user';
    div.innerHTML = `
        <div class="msg-bubble">${escapeHtml(texto)}</div>
        <div class="msg-time">${horaActual()}</div>
    `;
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
}

function agregarMensajeBot(html) {
    const chatbox = document.getElementById('chatbox');
    const div = document.createElement('div');
    div.className = 'message msg-bot';
    div.innerHTML = `
        <div class="msg-bubble">${html}</div>
        <div class="msg-time">${horaActual()}</div>
    `;
    chatbox.appendChild(div);
    chatbox.scrollTop = chatbox.scrollHeight;
}

function mostrarTyping(show) {
    document.getElementById('typing-row').classList.toggle('active', show);
}

async function enviarMensaje() {
    const input  = document.getElementById('chat-input');
    const btnSend = document.getElementById('btn-send');
    const mensaje = input.value.trim();
    if (!mensaje) return;

    agregarMensajeUsuario(mensaje);
    input.value       = '';
    btnSend.disabled  = true;
    mostrarTyping(true);

    try {
        const res  = await fetch(`${API_BASE}/api/consulta`, {
            method:  'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mensaje,
                usuario:  USUARIO_DNI || 'anonimo',
                metadata: { tarea_forzada: 'sifods' }
            })
        });

        const data = await res.json();
        mostrarTyping(false);
        agregarMensajeBot(data.respuesta || 'âŒ Sin respuesta del servidor.');

    } catch (err) {
        mostrarTyping(false);
        agregarMensajeBot('âŒ Error de conexiÃ³n. Por favor intenta de nuevo.');
        console.error(err);
    } finally {
        btnSend.disabled = false;
        document.getElementById('chatbox').scrollTop = 9999;
    }
}

function usarSugerencia(texto) {
    document.getElementById('chat-input').value = texto;
    enviarMensaje();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 2 â€” RECOMENDACIÃ“N DE CURSOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function cargarRecomendaciones() {
    // Si no hay DNI aÃºn, abrir modal primero
    if (!USUARIO_DNI) { abrirModalDni(); return; }

    // Reset UI
    document.getElementById('rec-loading').classList.remove('hidden');
    document.getElementById('rec-body').classList.add('hidden');
    document.getElementById('just-panel').classList.remove('visible');
    document.getElementById('loading-dni-text').textContent = `DNI: ${USUARIO_DNI}`;
    cursoSeleccionado = null;

    try {
        const res  = await fetch(`${API_BASE}/api/recomendar`, {
            method:  'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                usuario:  USUARIO_DNI,
                top_k:    5
            })
        });

        const data = await res.json();
        recomendacionesData = data.recomendaciones || [];

        renderizarCursos(recomendacionesData);

    } catch (err) {
        console.error('Error cargando recomendaciones:', err);
        document.getElementById('rec-loading').classList.add('hidden');
        document.getElementById('courses-grid').innerHTML =
            '<p style="color:var(--txt-soft);font-size:14px;">âŒ No se pudieron cargar las recomendaciones.</p>';
        document.getElementById('rec-body').classList.remove('hidden');
    }
}

function renderizarCursos(cursos) {
    document.getElementById('rec-loading').classList.add('hidden');
    document.getElementById('rec-count').textContent = cursos.length;

    const grid = document.getElementById('courses-grid');
    grid.innerHTML = '';

    if (cursos.length === 0) {
        grid.innerHTML = `
            <div style="grid-column:1/-1;text-align:center;padding:40px 0;">
                <div style="font-size:32px;margin-bottom:12px;">ğŸ“­</div>
                <div style="color:var(--txt-soft);font-size:14px;">
                    No hay recomendaciones disponibles en este momento.
                </div>
            </div>`;
        document.getElementById('rec-body').classList.remove('hidden');
        return;
    }

    cursos.forEach((curso, idx) => {
        const scorePorc   = Math.round((curso.score_final || 0) * 100);
        const tasa        = Math.round((curso.TASA_APROBACION || 0) * 100);
        const horas       = curso.HORAS_PROGRAMA || 0;
        const nombre      = curso.CURSO || 'Curso';
        const aÃ±o         = curso.AÃ‘O  || '';
        const metodos     = curso.metodos_usados || [];

        const card = document.createElement('div');
        card.className   = 'course-card';
        card.id          = `course-card-${idx}`;
        card.onclick     = () => seleccionarCurso(idx);

        card.innerHTML = `
            <div class="course-card-accent"></div>
            <div class="course-card-body">
                <div class="course-rank">#${idx + 1} RECOMENDADO</div>
                <div class="course-name">${escapeHtml(nombre)}</div>
                <div class="course-meta">
                    ${aÃ±o ? `<span class="course-tag">ğŸ“… ${aÃ±o}</span>` : ''}
                    <span class="course-tag">â±ï¸ ${horas}h</span>
                    <span class="course-tag">âœ… ${tasa}% aprob.</span>
                </div>
                <div class="course-stats">
                    <div class="stat">
                        <span class="stat-val">${scorePorc}%</span>
                        <span class="stat-lbl">Relevancia</span>
                    </div>
                    <div class="stat">
                        <span class="stat-val">${tasa}%</span>
                        <span class="stat-lbl">AprobaciÃ³n</span>
                    </div>
                </div>
            </div>
            <div class="course-card-footer">
                <div class="score-bar-wrap">
                    <div class="score-bar" style="width:${scorePorc}%"></div>
                </div>
                <span class="score-val">${(curso.score_final || 0).toFixed(2)}</span>
                <button class="btn-justificacion" onclick="event.stopPropagation(); seleccionarCurso(${idx})">
                    Ver por quÃ© â†’
                </button>
            </div>
        `;

        grid.appendChild(card);
    });

    document.getElementById('rec-body').classList.remove('hidden');
}

function seleccionarCurso(idx) {
    // Desmarcar anterior
    if (cursoSeleccionado !== null) {
        const prevCard = document.getElementById(`course-card-${cursoSeleccionado}`);
        if (prevCard) prevCard.classList.remove('selected');
    }

    // Si mismo curso, cerrar panel
    if (cursoSeleccionado === idx) {
        cursoSeleccionado = null;
        document.getElementById('just-panel').classList.remove('visible');
        return;
    }

    // Marcar nuevo
    cursoSeleccionado = idx;
    const card = document.getElementById(`course-card-${idx}`);
    card.classList.add('selected');

    // Mostrar panel de justificaciÃ³n
    const curso = recomendacionesData[idx];
    mostrarJustificacion(curso);
}

function mostrarJustificacion(curso) {
    const panel   = document.getElementById('just-panel');
    const nombre  = document.getElementById('just-course-name');
    const loading = document.getElementById('just-loading');
    const content = document.getElementById('just-content');
    const chips   = document.getElementById('just-chips');

    // Mostrar panel con loading
    nombre.textContent  = curso.CURSO || 'Curso';
    loading.style.display = 'flex';
    content.style.display = 'none';
    chips.innerHTML       = '';
    panel.classList.add('visible');

    // Scroll suave al panel
    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    // Si ya viene la justificaciÃ³n del backend, mostrar directo
    if (curso.justificacion) {
        loading.style.display = 'none';
        content.style.display = 'inline';
        content.textContent   = curso.justificacion;
        renderizarChips(curso);
        return;
    }

    // Si no viene, pedirla al backend
    fetchJustificacion(curso);
}

async function fetchJustificacion(curso) {
    const loading = document.getElementById('just-loading');
    const content = document.getElementById('just-content');
    const chips   = document.getElementById('just-chips');

    try {
        const res = await fetch(`${API_BASE}/api/recomendar`, {
            method:  'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                usuario: USUARIO_DNI,
                top_k:   1
            })
        });

        const data = await res.json();
        const just = data.recomendaciones?.[0]?.justificacion
            || curso.justificacion
            || 'Curso relevante para tu perfil docente.';

        loading.style.display = 'none';
        content.style.display = 'inline';
        content.textContent   = just;
        curso.justificacion   = just; // cachear
        renderizarChips(curso);

    } catch (err) {
        loading.style.display = 'none';
        content.style.display = 'inline';
        content.textContent   = 'Curso relevante para tu perfil y regiÃ³n educativa.';
        renderizarChips(curso);
    }
}

function renderizarChips(curso) {
    const chips   = document.getElementById('just-chips');
    chips.innerHTML = '';

    const metodos = curso.metodos_usados || [];

    const etiquetas = {
        'colaborativo':         { label: 'ğŸ‘¥ Docentes similares', cls: 'highlight' },
        'popularidad':          { label: 'ğŸ“ˆ Curso popular',       cls: 'highlight' },
        'historial':            { label: 'ğŸ“š Tu perfil',           cls: 'highlight' },
        'novedad':              { label: 'âœ¨ Curso reciente',       cls: '' },
        'popularidad_fallback': { label: 'â­ Top valorado',         cls: '' },
    };

    metodos.forEach(m => {
        if (etiquetas[m]) {
            const chip = document.createElement('span');
            chip.className   = `just-chip ${etiquetas[m].cls}`;
            chip.textContent = etiquetas[m].label;
            chips.appendChild(chip);
        }
    });

    // Tasa de aprobaciÃ³n como chip
    if (curso.TASA_APROBACION) {
        const chip = document.createElement('span');
        chip.className   = 'just-chip';
        chip.textContent = `âœ… ${Math.round(curso.TASA_APROBACION * 100)}% de aprobaciÃ³n`;
        chips.appendChild(chip);
    }

    if (curso.HORAS_PROGRAMA) {
        const chip = document.createElement('span');
        chip.className   = 'just-chip';
        chip.textContent = `â±ï¸ ${curso.HORAS_PROGRAMA} horas`;
        chips.appendChild(chip);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILIDADES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function escapeHtml(str) {
    const d = document.createElement('div');
    d.appendChild(document.createTextNode(str));
    return d.innerHTML;
}

function horaActual() {
    return new Date().toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
}
</script>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MODAL IDENTIFICACIÃ“N DNI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="modal-dni">
    <div class="modal-card">
        <div class="modal-icon-wrap">ğŸ“</div>
        <div class="modal-title">IdentifÃ­cate para continuar</div>
        <div class="modal-subtitle">
            Ingresa tu DNI para ver cursos personalizados<br>
            segÃºn tu historial y perfil como docente.
        </div>
        <div class="modal-info">
            <span class="modal-info-icon">ğŸ’¡</span>
            <span>Tu DNI es el <strong>usuario_documento</strong> con el que estÃ¡s registrado en SIFODS. Lo usamos para calcular recomendaciones basadas en tu trayectoria.</span>
        </div>
        <label class="dni-input-label" for="input-dni">NÃºmero de DNI</label>
        <div class="dni-input-wrap">
            <input
                type="text" id="input-dni"
                class="dni-input-field"
                placeholder="00000000"
                maxlength="8"
                inputmode="numeric"
                autocomplete="off"
                oninput="onDniInput(this)"
                onkeydown="if(event.key==='Enter') confirmarDni()"
            >
            <span class="dni-char-count" id="dni-char-count">0/8</span>
        </div>
        <div class="dni-error-msg" id="dni-error"></div>
        <button class="btn-modal-primary" id="btn-confirmar-dni"
                onclick="confirmarDni()" disabled>
            <span>Ver mis recomendaciones</span>
            <span>â†’</span>
        </button>
        <div class="modal-footer-note">
            Sin historial en SIFODS, verÃ¡s igualmente los cursos mÃ¡s relevantes para tu regiÃ³n.
            <span id="link-cancelar" style="display:none;"><br>
                <a onclick="cancelarModal()">Cancelar y mantener sesiÃ³n anterior</a>
            </span>
        </div>
    </div>
</div>

</body>
</html>